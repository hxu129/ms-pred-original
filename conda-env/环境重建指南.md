# 统一环境重建指南 (Environment Reconstruction Guide)

本指南说明如何在新机器上重建 DiffMS 和 ms-pred 的统一开发环境。

---

## 📋 目录 (Table of Contents)

1. [前提条件](#前提条件)
2. [快速重建（使用环境文件）](#快速重建使用环境文件)
3. [完整手动重建（从零开始）](#完整手动重建从零开始)
4. [验证环境](#验证环境)
5. [常见问题](#常见问题)

---

## 🔧 前提条件

在开始之前，确保新机器满足以下条件：

### 硬件要求
- ✅ NVIDIA GPU（推荐：至少16GB显存）
- ✅ CUDA Driver 11.8+ （本环境使用 CUDA 11.8）
- ✅ 足够的磁盘空间（至少20GB用于环境）

### 软件要求
- ✅ Linux 操作系统（Ubuntu 18.04+ 或类似）
- ✅ Git（用于克隆代码仓库）
- ✅ wget 或 curl（用于下载安装包）

### 检查 GPU 和 CUDA
```bash
# 检查 NVIDIA 驱动和 CUDA
nvidia-smi

# 检查 CUDA 版本
nvcc --version  # 如果安装了 CUDA toolkit
```

---

## 🚀 快速重建（使用环境文件）

如果你有原环境的导出文件，这是最快的方法。

### 步骤 1: 导出当前环境（在原机器上）

```bash
# 激活环境
mamba activate unified-ms-env

# 导出完整环境配置
mamba env export > unified-ms-env-full.yml

# 或导出跨平台配置（推荐）
mamba env export --from-history > unified-ms-env-simple.yml

# 导出 pip 包列表
pip list --format=freeze > pip-requirements.txt
```

### 步骤 2: 复制必要文件到新机器

需要复制的文件：
```
/root/ms/
├── unified_environment.yml          # conda环境定义
├── unified_requirements.txt         # pip依赖
├── unified-ms-env-full.yml         # （可选）完整导出
├── DiffMS/                         # DiffMS项目代码
│   └── [所有代码文件和修改]
└── ms-pred/                        # ms-pred项目代码
    └── [所有代码文件和修改]
```

### 步骤 3: 在新机器上安装 Miniforge

```bash
# 下载 Miniforge
cd /tmp
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh

# 安装（批处理模式）
bash Miniforge3-Linux-x86_64.sh -b -p $HOME/miniforge3

# 初始化 bash
$HOME/miniforge3/bin/conda init bash
source ~/.bashrc
```

### 步骤 4: 重建环境

#### 方法 A: 使用完整导出文件（最简单）
```bash
cd /root/ms
mamba env create -f unified-ms-env-full.yml
```

#### 方法 B: 使用原始配置文件（推荐）
```bash
cd /root/ms

# 1. 创建基础环境
mamba env create -f unified_environment.yml

# 2. 激活环境
mamba activate unified-ms-env

# 3. 安装 PyTorch 相关包
pip install torch==2.3.1 torchvision==0.18.1 --index-url https://download.pytorch.org/whl/cu118

# 4. 安装 PyTorch Lightning 和 torchmetrics
pip install pytorch-lightning==2.0.4 torchmetrics==0.11.4

# 5. 安装 torch-geometric
pip install torch-geometric==2.3.1

# 6. 安装 torch-scatter 和 torch-sparse
pip install torch-scatter torch-sparse -f https://data.pyg.org/whl/torch-2.3.1+cu118.html

# 7. 安装 DGL
pip install dgl -f https://data.dgl.ai/wheels/torch-2.3/cu118/repo.html

# 8. 安装其他依赖
pip install -r unified_requirements.txt
```

### 步骤 5: 安装项目

```bash
# 安装 DiffMS
cd /root/ms/DiffMS
pip install -e .

# 安装 ms-pred
cd /root/ms/ms-pred
python setup.py develop
```

---

## 🔨 完整手动重建（从零开始）

如果没有环境导出文件，按照以下步骤从零开始。

### 第一步：克隆代码仓库

```bash
# 创建工作目录
mkdir -p /root/ms
cd /root/ms

# 克隆 DiffMS（替换为实际 git 地址）
git clone <DiffMS-repo-url> DiffMS

# 克隆 ms-pred（替换为实际 git 地址）
git clone <ms-pred-repo-url> ms-pred
```

### 第二步：安装 Miniforge

```bash
cd /tmp
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
bash Miniforge3-Linux-x86_64.sh -b -p $HOME/miniforge3
$HOME/miniforge3/bin/conda init bash
source ~/.bashrc
```

### 第三步：创建环境配置文件

#### 创建 `unified_environment.yml`

```bash
cat > /root/ms/unified_environment.yml << 'EOF'
name: unified-ms-env
channels:
  - conda-forge
  - pytorch
  - bioconda
dependencies:
  - python=3.9.*
  - rdkit=2024.09.4
  - numpy=1.23.*
  - pandas=1.4.*
  - matplotlib=3.7.1
  - seaborn
  - cython
  - ipykernel=6.0.*
  - nb_conda_kernels=2.3.*
  - ipdb
  - conda-forge::python-graphviz=0.17
  - conda-forge::pygraphviz=1.7
  - einops
  - h5py
  - scikit-learn
  - setuptools=68.0.0
  - ray-tune
  - MKL=2024.0.0
EOF
```

#### 创建 `unified_requirements.txt`

```bash
cat > /root/ms/unified_requirements.txt << 'EOF'
# PyTorch Lightning ecosystem
pytorch-lightning==2.0.4
torchmetrics==0.11.4

# DiffMS dependencies
hydra-core==1.3.2
omegaconf==2.3.0
overrides==7.3.1
tqdm
wandb
myopic-mces
tqdm-joblib

# ms-pred dependencies
pathos
CairoSVG
pubchempy
pygmtools
msbuddy
lightgbm
EOF
```

### 第四步：创建和配置环境

```bash
# 创建环境
cd /root/ms
mamba env create -f unified_environment.yml

# 激活环境
mamba activate unified-ms-env

# 安装 PyTorch 和相关包（按顺序）
pip install torch==2.3.1 torchvision==0.18.1 --index-url https://download.pytorch.org/whl/cu118
pip install pytorch-lightning==2.0.4 torchmetrics==0.11.4
pip install torch-geometric==2.3.1
pip install torch-scatter torch-sparse -f https://data.pyg.org/whl/torch-2.3.1+cu118.html
pip install dgl -f https://data.dgl.ai/wheels/torch-2.3/cu118/repo.html

# 安装其他依赖
pip install -r unified_requirements.txt
```

### 第五步：修复 ms-pred 代码

#### 5.1 修复 Cython 编译错误

编辑文件：`/root/ms/ms-pred/src/ms_pred/massformer_pred/massformer_code/algos2.pyx`

在文件开头添加：
```python
from libc.stdint cimport int64_t
```

替换所有的 `long` 为 `int64_t`：
- 第 15 行：`adjacency_matrix.astype(numpy.int64, ...)`
- 第 17-25 行：所有 `long` 改为 `int64_t`
- 第 73-78 行：所有 `long` 改为 `int64_t`

#### 5.2 修复 PyTorch Lightning API

需要修改 13 个文件，将：
```python
best_checkpoint_score = checkpoint_callback.best_model_score.item()
```
改为：
```python
best_checkpoint_score = checkpoint_callback.best_model_score
```

**需要修改的文件列表：**
1. `src/ms_pred/scarf_pred/train_inten.py` (line 267)
2. `src/ms_pred/scarf_pred/train_gen.py` (line 282)
3. `src/ms_pred/molnetms/train.py` (line 223)
4. `src/ms_pred/massformer_pred/train.py` (line 237)
5. `src/ms_pred/marason/train_inten.py` (line 635)
6. `src/ms_pred/marason/train_gen.py` (line 275)
7. `src/ms_pred/ffn_pred/train.py` (line 212)
8. `src/ms_pred/graff_ms/train.py` (line 255)
9. `src/ms_pred/gnn_pred/train.py` (line 236)
10. `src/ms_pred/dag_pred/train_inten.py` (line 300)
11. `src/ms_pred/dag_pred/train_gen.py` (line 273)
12. `src/ms_pred/dag_pred/train_contr_inten.py` (line 320)
13. `src/ms_pred/autoregr_gen/train.py` (line 289)

**批量修改脚本：**
```bash
cd /root/ms/ms-pred

# 备份文件
for file in \
  src/ms_pred/scarf_pred/train_inten.py \
  src/ms_pred/scarf_pred/train_gen.py \
  src/ms_pred/molnetms/train.py \
  src/ms_pred/massformer_pred/train.py \
  src/ms_pred/marason/train_inten.py \
  src/ms_pred/marason/train_gen.py \
  src/ms_pred/ffn_pred/train.py \
  src/ms_pred/graff_ms/train.py \
  src/ms_pred/gnn_pred/train.py \
  src/ms_pred/dag_pred/train_inten.py \
  src/ms_pred/dag_pred/train_gen.py \
  src/ms_pred/dag_pred/train_contr_inten.py \
  src/ms_pred/autoregr_gen/train.py
do
  cp "$file" "$file.backup"
  sed -i 's/checkpoint_callback\.best_model_score\.item()/checkpoint_callback.best_model_score/g' "$file"
  echo "Modified: $file"
done
```

### 第六步：安装项目

```bash
# 安装 DiffMS
cd /root/ms/DiffMS
pip install -e .

# 安装 ms-pred
cd /root/ms/ms-pred
python setup.py develop
```

---

## ✅ 验证环境

运行以下命令验证环境是否正确安装：

### 基础验证

```bash
# 激活环境
mamba activate unified-ms-env

# 验证 Python 版本
python --version
# 期望输出: Python 3.9.x

# 验证 PyTorch 和 CUDA
python -c "
import torch
print(f'PyTorch: {torch.__version__}')
print(f'CUDA available: {torch.cuda.is_available()}')
print(f'CUDA version: {torch.version.cuda}')
"
# 期望输出:
# PyTorch: 2.3.1+cu118
# CUDA available: True
# CUDA version: 11.8

# 验证 PyTorch Lightning
python -c "import pytorch_lightning as pl; print(f'PyTorch Lightning: {pl.__version__}')"
# 期望输出: PyTorch Lightning: 2.0.4

# 验证 torch_geometric
python -c "import torch_geometric; print(f'torch_geometric: {torch_geometric.__version__}')"
# 期望输出: torch_geometric: 2.3.1

# 验证 DGL
python -c "import dgl; print(f'DGL: {dgl.__version__}')"
# 期望输出: DGL: 2.4.0+cu118

# 验证 RDKit
python -c "
import rdkit
from rdkit import Chem
print(f'RDKit: {rdkit.__version__}')
mol = Chem.MolFromSmiles('CCO')
print('RDKit functional test: PASSED' if mol else 'FAILED')
"
# 期望输出:
# RDKit: 2024.09.4
# RDKit functional test: PASSED
```

### 项目导入验证

```bash
# 验证 DiffMS
python -c "
from src import utils as diffms_utils
from src.diffusion_model_fp2mol import FP2MolDenoisingDiffusion
print('✓ DiffMS imported successfully')
"

# 验证 ms-pred
python -c "
import ms_pred
from ms_pred.dag_pred import inten_model, gen_model
print('✓ ms-pred imported successfully')
"
```

### GPU 功能验证

```bash
# 测试 GPU 计算
python -c "
import torch
if torch.cuda.is_available():
    x = torch.randn(1000, 1000).cuda()
    y = torch.randn(1000, 1000).cuda()
    z = torch.mm(x, y)
    print('✓ GPU computation test PASSED')
    print(f'GPU: {torch.cuda.get_device_name(0)}')
    print(f'GPU Memory: {torch.cuda.get_device_properties(0).total_memory / 1e9:.2f} GB')
else:
    print('✗ CUDA not available')
"
```

---

## 🔍 常见问题

### Q1: ImportError: cannot import name 'xxx'

**原因：** 可能是包版本不兼容或未安装

**解决方案：**
```bash
# 重新安装有问题的包
pip install --force-reinstall <package_name>

# 或检查环境是否激活
mamba activate unified-ms-env
```

### Q2: CUDA out of memory

**原因：** GPU 显存不足

**解决方案：**
- 减小 batch size
- 使用梯度累积
- 使用混合精度训练（AMP）

### Q3: Cython 编译错误

**原因：** algos2.pyx 文件中的 `long` 类型问题

**解决方案：**
确保已经应用了第五步中的 Cython 修复（将 `long` 改为 `int64_t`）

### Q4: ModuleNotFoundError: No module named 'diffms'

**原因：** DiffMS 使用 `src` 作为包名

**解决方案：**
```python
# 正确的导入方式
from src import utils

# 错误的导入方式
import diffms  # 不会工作
```

### Q5: 环境创建很慢

**原因：** 网络问题或包依赖解析

**解决方案：**
```bash
# 使用国内镜像（如果在中国）
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/

# 使用 mamba 而不是 conda（更快）
mamba env create -f unified_environment.yml
```

---

## 📝 重建检查清单

在重建完成后，使用此清单确保所有步骤都已完成：

- [ ] ✅ Miniforge 已安装
- [ ] ✅ 环境配置文件已创建（unified_environment.yml, unified_requirements.txt）
- [ ] ✅ conda 环境已创建（unified-ms-env）
- [ ] ✅ PyTorch 2.3.1+cu118 已安装
- [ ] ✅ PyTorch Lightning 2.0.4 已安装
- [ ] ✅ torch_geometric 2.3.1 已安装
- [ ] ✅ DGL 2.4.0+cu118 已安装
- [ ] ✅ 其他依赖已安装
- [ ] ✅ ms-pred Cython 文件已修复
- [ ] ✅ ms-pred PyTorch Lightning API 已更新（13个文件）
- [ ] ✅ DiffMS 已安装（pip install -e .）
- [ ] ✅ ms-pred 已安装（python setup.py develop）
- [ ] ✅ 基础验证测试通过
- [ ] ✅ 项目导入验证通过
- [ ] ✅ GPU 功能验证通过

---

## 📚 相关文档

- **详细安装文档：** `/root/ms/UNIFIED_ENVIRONMENT_SETUP_SUMMARY.md`
- **环境配置：** `/root/ms/unified_environment.yml`
- **Python 依赖：** `/root/ms/unified_requirements.txt`
- **DiffMS README：** `/root/ms/DiffMS/README.md`
- **ms-pred README：** `/root/ms/ms-pred/README.md`

---

## 💡 提示

1. **环境导出建议：** 在原机器上定期导出环境配置
   ```bash
   mamba env export > unified-ms-env-$(date +%Y%m%d).yml
   ```

2. **使用容器化：** 考虑使用 Docker 或 Singularity 容器来简化部署
   ```dockerfile
   FROM continuumio/miniconda3
   # ... 添加安装步骤
   ```

3. **版本控制：** 将代码修改（Cython 修复、API 更新）提交到 git
   ```bash
   git commit -am "Fix: PyTorch Lightning 2.0 compatibility"
   ```

4. **自动化脚本：** 创建安装脚本自动化这些步骤

---

**文档版本：** 1.0  
**创建日期：** 2025-10-16  
**最后更新：** 2025-10-16  
**维护者：** [Your Name]

