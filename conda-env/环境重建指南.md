# ç»Ÿä¸€ç¯å¢ƒé‡å»ºæŒ‡å— (Environment Reconstruction Guide)

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•åœ¨æ–°æœºå™¨ä¸Šé‡å»º DiffMS å’Œ ms-pred çš„ç»Ÿä¸€å¼€å‘ç¯å¢ƒã€‚

---

## ğŸ“‹ ç›®å½• (Table of Contents)

1. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
2. [å¿«é€Ÿé‡å»ºï¼ˆä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ï¼‰](#å¿«é€Ÿé‡å»ºä½¿ç”¨ç¯å¢ƒæ–‡ä»¶)
3. [å®Œæ•´æ‰‹åŠ¨é‡å»ºï¼ˆä»é›¶å¼€å§‹ï¼‰](#å®Œæ•´æ‰‹åŠ¨é‡å»ºä»é›¶å¼€å§‹)
4. [éªŒè¯ç¯å¢ƒ](#éªŒè¯ç¯å¢ƒ)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”§ å‰ææ¡ä»¶

åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿æ–°æœºå™¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

### ç¡¬ä»¶è¦æ±‚
- âœ… NVIDIA GPUï¼ˆæ¨èï¼šè‡³å°‘16GBæ˜¾å­˜ï¼‰
- âœ… CUDA Driver 11.8+ ï¼ˆæœ¬ç¯å¢ƒä½¿ç”¨ CUDA 11.8ï¼‰
- âœ… è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘20GBç”¨äºç¯å¢ƒï¼‰

### è½¯ä»¶è¦æ±‚
- âœ… Linux æ“ä½œç³»ç»Ÿï¼ˆUbuntu 18.04+ æˆ–ç±»ä¼¼ï¼‰
- âœ… Gitï¼ˆç”¨äºå…‹éš†ä»£ç ä»“åº“ï¼‰
- âœ… wget æˆ– curlï¼ˆç”¨äºä¸‹è½½å®‰è£…åŒ…ï¼‰

### æ£€æŸ¥ GPU å’Œ CUDA
```bash
# æ£€æŸ¥ NVIDIA é©±åŠ¨å’Œ CUDA
nvidia-smi

# æ£€æŸ¥ CUDA ç‰ˆæœ¬
nvcc --version  # å¦‚æœå®‰è£…äº† CUDA toolkit
```

---

## ğŸš€ å¿«é€Ÿé‡å»ºï¼ˆä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ï¼‰

å¦‚æœä½ æœ‰åŸç¯å¢ƒçš„å¯¼å‡ºæ–‡ä»¶ï¼Œè¿™æ˜¯æœ€å¿«çš„æ–¹æ³•ã€‚

### æ­¥éª¤ 1: å¯¼å‡ºå½“å‰ç¯å¢ƒï¼ˆåœ¨åŸæœºå™¨ä¸Šï¼‰

```bash
# æ¿€æ´»ç¯å¢ƒ
mamba activate unified-ms-env

# å¯¼å‡ºå®Œæ•´ç¯å¢ƒé…ç½®
mamba env export > unified-ms-env-full.yml

# æˆ–å¯¼å‡ºè·¨å¹³å°é…ç½®ï¼ˆæ¨èï¼‰
mamba env export --from-history > unified-ms-env-simple.yml

# å¯¼å‡º pip åŒ…åˆ—è¡¨
pip list --format=freeze > pip-requirements.txt
```

### æ­¥éª¤ 2: å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°æ–°æœºå™¨

éœ€è¦å¤åˆ¶çš„æ–‡ä»¶ï¼š
```
/root/ms/
â”œâ”€â”€ unified_environment.yml          # condaç¯å¢ƒå®šä¹‰
â”œâ”€â”€ unified_requirements.txt         # pipä¾èµ–
â”œâ”€â”€ unified-ms-env-full.yml         # ï¼ˆå¯é€‰ï¼‰å®Œæ•´å¯¼å‡º
â”œâ”€â”€ DiffMS/                         # DiffMSé¡¹ç›®ä»£ç 
â”‚   â””â”€â”€ [æ‰€æœ‰ä»£ç æ–‡ä»¶å’Œä¿®æ”¹]
â””â”€â”€ ms-pred/                        # ms-predé¡¹ç›®ä»£ç 
    â””â”€â”€ [æ‰€æœ‰ä»£ç æ–‡ä»¶å’Œä¿®æ”¹]
```

### æ­¥éª¤ 3: åœ¨æ–°æœºå™¨ä¸Šå®‰è£… Miniforge

```bash
# ä¸‹è½½ Miniforge
cd /tmp
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh

# å®‰è£…ï¼ˆæ‰¹å¤„ç†æ¨¡å¼ï¼‰
bash Miniforge3-Linux-x86_64.sh -b -p $HOME/miniforge3

# åˆå§‹åŒ– bash
$HOME/miniforge3/bin/conda init bash
source ~/.bashrc
```

### æ­¥éª¤ 4: é‡å»ºç¯å¢ƒ

#### æ–¹æ³• A: ä½¿ç”¨å®Œæ•´å¯¼å‡ºæ–‡ä»¶ï¼ˆæœ€ç®€å•ï¼‰
```bash
cd /root/ms
mamba env create -f unified-ms-env-full.yml
```

#### æ–¹æ³• B: ä½¿ç”¨åŸå§‹é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
```bash
cd /root/ms

# 1. åˆ›å»ºåŸºç¡€ç¯å¢ƒ
mamba env create -f unified_environment.yml

# 2. æ¿€æ´»ç¯å¢ƒ
mamba activate unified-ms-env

# 3. å®‰è£… PyTorch ç›¸å…³åŒ…
pip install torch==2.3.1 torchvision==0.18.1 --index-url https://download.pytorch.org/whl/cu118

# 4. å®‰è£… PyTorch Lightning å’Œ torchmetrics
pip install pytorch-lightning==2.0.4 torchmetrics==0.11.4

# 5. å®‰è£… torch-geometric
pip install torch-geometric==2.3.1

# 6. å®‰è£… torch-scatter å’Œ torch-sparse
pip install torch-scatter torch-sparse -f https://data.pyg.org/whl/torch-2.3.1+cu118.html

# 7. å®‰è£… DGL
pip install dgl -f https://data.dgl.ai/wheels/torch-2.3/cu118/repo.html

# 8. å®‰è£…å…¶ä»–ä¾èµ–
pip install -r unified_requirements.txt
```

### æ­¥éª¤ 5: å®‰è£…é¡¹ç›®

```bash
# å®‰è£… DiffMS
cd /root/ms/DiffMS
pip install -e .

# å®‰è£… ms-pred
cd /root/ms/ms-pred
python setup.py develop
```

---

## ğŸ”¨ å®Œæ•´æ‰‹åŠ¨é‡å»ºï¼ˆä»é›¶å¼€å§‹ï¼‰

å¦‚æœæ²¡æœ‰ç¯å¢ƒå¯¼å‡ºæ–‡ä»¶ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä»é›¶å¼€å§‹ã€‚

### ç¬¬ä¸€æ­¥ï¼šå…‹éš†ä»£ç ä»“åº“

```bash
# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p /root/ms
cd /root/ms

# å…‹éš† DiffMSï¼ˆæ›¿æ¢ä¸ºå®é™… git åœ°å€ï¼‰
git clone <DiffMS-repo-url> DiffMS

# å…‹éš† ms-predï¼ˆæ›¿æ¢ä¸ºå®é™… git åœ°å€ï¼‰
git clone <ms-pred-repo-url> ms-pred
```

### ç¬¬äºŒæ­¥ï¼šå®‰è£… Miniforge

```bash
cd /tmp
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
bash Miniforge3-Linux-x86_64.sh -b -p $HOME/miniforge3
$HOME/miniforge3/bin/conda init bash
source ~/.bashrc
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶

#### åˆ›å»º `unified_environment.yml`

```bash
cat > /root/ms/unified_environment.yml << 'EOF'
name: unified-ms-env
channels:
  - conda-forge
  - pytorch
  - bioconda
dependencies:
  - python=3.9.*
  - rdkit=2024.09.4
  - numpy=1.23.*
  - pandas=1.4.*
  - matplotlib=3.7.1
  - seaborn
  - cython
  - ipykernel=6.0.*
  - nb_conda_kernels=2.3.*
  - ipdb
  - conda-forge::python-graphviz=0.17
  - conda-forge::pygraphviz=1.7
  - einops
  - h5py
  - scikit-learn
  - setuptools=68.0.0
  - ray-tune
  - MKL=2024.0.0
EOF
```

#### åˆ›å»º `unified_requirements.txt`

```bash
cat > /root/ms/unified_requirements.txt << 'EOF'
# PyTorch Lightning ecosystem
pytorch-lightning==2.0.4
torchmetrics==0.11.4

# DiffMS dependencies
hydra-core==1.3.2
omegaconf==2.3.0
overrides==7.3.1
tqdm
wandb
myopic-mces
tqdm-joblib

# ms-pred dependencies
pathos
CairoSVG
pubchempy
pygmtools
msbuddy
lightgbm
EOF
```

### ç¬¬å››æ­¥ï¼šåˆ›å»ºå’Œé…ç½®ç¯å¢ƒ

```bash
# åˆ›å»ºç¯å¢ƒ
cd /root/ms
mamba env create -f unified_environment.yml

# æ¿€æ´»ç¯å¢ƒ
mamba activate unified-ms-env

# å®‰è£… PyTorch å’Œç›¸å…³åŒ…ï¼ˆæŒ‰é¡ºåºï¼‰
pip install torch==2.3.1 torchvision==0.18.1 --index-url https://download.pytorch.org/whl/cu118
pip install pytorch-lightning==2.0.4 torchmetrics==0.11.4
pip install torch-geometric==2.3.1
pip install torch-scatter torch-sparse -f https://data.pyg.org/whl/torch-2.3.1+cu118.html
pip install dgl -f https://data.dgl.ai/wheels/torch-2.3/cu118/repo.html

# å®‰è£…å…¶ä»–ä¾èµ–
pip install -r unified_requirements.txt
```

### ç¬¬äº”æ­¥ï¼šä¿®å¤ ms-pred ä»£ç 

#### 5.1 ä¿®å¤ Cython ç¼–è¯‘é”™è¯¯

ç¼–è¾‘æ–‡ä»¶ï¼š`/root/ms/ms-pred/src/ms_pred/massformer_pred/massformer_code/algos2.pyx`

åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š
```python
from libc.stdint cimport int64_t
```

æ›¿æ¢æ‰€æœ‰çš„ `long` ä¸º `int64_t`ï¼š
- ç¬¬ 15 è¡Œï¼š`adjacency_matrix.astype(numpy.int64, ...)`
- ç¬¬ 17-25 è¡Œï¼šæ‰€æœ‰ `long` æ”¹ä¸º `int64_t`
- ç¬¬ 73-78 è¡Œï¼šæ‰€æœ‰ `long` æ”¹ä¸º `int64_t`

#### 5.2 ä¿®å¤ PyTorch Lightning API

éœ€è¦ä¿®æ”¹ 13 ä¸ªæ–‡ä»¶ï¼Œå°†ï¼š
```python
best_checkpoint_score = checkpoint_callback.best_model_score.item()
```
æ”¹ä¸ºï¼š
```python
best_checkpoint_score = checkpoint_callback.best_model_score
```

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ï¼š**
1. `src/ms_pred/scarf_pred/train_inten.py` (line 267)
2. `src/ms_pred/scarf_pred/train_gen.py` (line 282)
3. `src/ms_pred/molnetms/train.py` (line 223)
4. `src/ms_pred/massformer_pred/train.py` (line 237)
5. `src/ms_pred/marason/train_inten.py` (line 635)
6. `src/ms_pred/marason/train_gen.py` (line 275)
7. `src/ms_pred/ffn_pred/train.py` (line 212)
8. `src/ms_pred/graff_ms/train.py` (line 255)
9. `src/ms_pred/gnn_pred/train.py` (line 236)
10. `src/ms_pred/dag_pred/train_inten.py` (line 300)
11. `src/ms_pred/dag_pred/train_gen.py` (line 273)
12. `src/ms_pred/dag_pred/train_contr_inten.py` (line 320)
13. `src/ms_pred/autoregr_gen/train.py` (line 289)

**æ‰¹é‡ä¿®æ”¹è„šæœ¬ï¼š**
```bash
cd /root/ms/ms-pred

# å¤‡ä»½æ–‡ä»¶
for file in \
  src/ms_pred/scarf_pred/train_inten.py \
  src/ms_pred/scarf_pred/train_gen.py \
  src/ms_pred/molnetms/train.py \
  src/ms_pred/massformer_pred/train.py \
  src/ms_pred/marason/train_inten.py \
  src/ms_pred/marason/train_gen.py \
  src/ms_pred/ffn_pred/train.py \
  src/ms_pred/graff_ms/train.py \
  src/ms_pred/gnn_pred/train.py \
  src/ms_pred/dag_pred/train_inten.py \
  src/ms_pred/dag_pred/train_gen.py \
  src/ms_pred/dag_pred/train_contr_inten.py \
  src/ms_pred/autoregr_gen/train.py
do
  cp "$file" "$file.backup"
  sed -i 's/checkpoint_callback\.best_model_score\.item()/checkpoint_callback.best_model_score/g' "$file"
  echo "Modified: $file"
done
```

### ç¬¬å…­æ­¥ï¼šå®‰è£…é¡¹ç›®

```bash
# å®‰è£… DiffMS
cd /root/ms/DiffMS
pip install -e .

# å®‰è£… ms-pred
cd /root/ms/ms-pred
python setup.py develop
```

---

## âœ… éªŒè¯ç¯å¢ƒ

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ç¯å¢ƒæ˜¯å¦æ­£ç¡®å®‰è£…ï¼š

### åŸºç¡€éªŒè¯

```bash
# æ¿€æ´»ç¯å¢ƒ
mamba activate unified-ms-env

# éªŒè¯ Python ç‰ˆæœ¬
python --version
# æœŸæœ›è¾“å‡º: Python 3.9.x

# éªŒè¯ PyTorch å’Œ CUDA
python -c "
import torch
print(f'PyTorch: {torch.__version__}')
print(f'CUDA available: {torch.cuda.is_available()}')
print(f'CUDA version: {torch.version.cuda}')
"
# æœŸæœ›è¾“å‡º:
# PyTorch: 2.3.1+cu118
# CUDA available: True
# CUDA version: 11.8

# éªŒè¯ PyTorch Lightning
python -c "import pytorch_lightning as pl; print(f'PyTorch Lightning: {pl.__version__}')"
# æœŸæœ›è¾“å‡º: PyTorch Lightning: 2.0.4

# éªŒè¯ torch_geometric
python -c "import torch_geometric; print(f'torch_geometric: {torch_geometric.__version__}')"
# æœŸæœ›è¾“å‡º: torch_geometric: 2.3.1

# éªŒè¯ DGL
python -c "import dgl; print(f'DGL: {dgl.__version__}')"
# æœŸæœ›è¾“å‡º: DGL: 2.4.0+cu118

# éªŒè¯ RDKit
python -c "
import rdkit
from rdkit import Chem
print(f'RDKit: {rdkit.__version__}')
mol = Chem.MolFromSmiles('CCO')
print('RDKit functional test: PASSED' if mol else 'FAILED')
"
# æœŸæœ›è¾“å‡º:
# RDKit: 2024.09.4
# RDKit functional test: PASSED
```

### é¡¹ç›®å¯¼å…¥éªŒè¯

```bash
# éªŒè¯ DiffMS
python -c "
from src import utils as diffms_utils
from src.diffusion_model_fp2mol import FP2MolDenoisingDiffusion
print('âœ“ DiffMS imported successfully')
"

# éªŒè¯ ms-pred
python -c "
import ms_pred
from ms_pred.dag_pred import inten_model, gen_model
print('âœ“ ms-pred imported successfully')
"
```

### GPU åŠŸèƒ½éªŒè¯

```bash
# æµ‹è¯• GPU è®¡ç®—
python -c "
import torch
if torch.cuda.is_available():
    x = torch.randn(1000, 1000).cuda()
    y = torch.randn(1000, 1000).cuda()
    z = torch.mm(x, y)
    print('âœ“ GPU computation test PASSED')
    print(f'GPU: {torch.cuda.get_device_name(0)}')
    print(f'GPU Memory: {torch.cuda.get_device_properties(0).total_memory / 1e9:.2f} GB')
else:
    print('âœ— CUDA not available')
"
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ImportError: cannot import name 'xxx'

**åŸå› ï¼š** å¯èƒ½æ˜¯åŒ…ç‰ˆæœ¬ä¸å…¼å®¹æˆ–æœªå®‰è£…

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°å®‰è£…æœ‰é—®é¢˜çš„åŒ…
pip install --force-reinstall <package_name>

# æˆ–æ£€æŸ¥ç¯å¢ƒæ˜¯å¦æ¿€æ´»
mamba activate unified-ms-env
```

### Q2: CUDA out of memory

**åŸå› ï¼š** GPU æ˜¾å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**
- å‡å° batch size
- ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯
- ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆAMPï¼‰

### Q3: Cython ç¼–è¯‘é”™è¯¯

**åŸå› ï¼š** algos2.pyx æ–‡ä»¶ä¸­çš„ `long` ç±»å‹é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
ç¡®ä¿å·²ç»åº”ç”¨äº†ç¬¬äº”æ­¥ä¸­çš„ Cython ä¿®å¤ï¼ˆå°† `long` æ”¹ä¸º `int64_t`ï¼‰

### Q4: ModuleNotFoundError: No module named 'diffms'

**åŸå› ï¼š** DiffMS ä½¿ç”¨ `src` ä½œä¸ºåŒ…å

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ­£ç¡®çš„å¯¼å…¥æ–¹å¼
from src import utils

# é”™è¯¯çš„å¯¼å…¥æ–¹å¼
import diffms  # ä¸ä¼šå·¥ä½œ
```

### Q5: ç¯å¢ƒåˆ›å»ºå¾ˆæ…¢

**åŸå› ï¼š** ç½‘ç»œé—®é¢˜æˆ–åŒ…ä¾èµ–è§£æ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨å›½å†…é•œåƒï¼ˆå¦‚æœåœ¨ä¸­å›½ï¼‰
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/

# ä½¿ç”¨ mamba è€Œä¸æ˜¯ condaï¼ˆæ›´å¿«ï¼‰
mamba env create -f unified_environment.yml
```

---

## ğŸ“ é‡å»ºæ£€æŸ¥æ¸…å•

åœ¨é‡å»ºå®Œæˆåï¼Œä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½å·²å®Œæˆï¼š

- [ ] âœ… Miniforge å·²å®‰è£…
- [ ] âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼ˆunified_environment.yml, unified_requirements.txtï¼‰
- [ ] âœ… conda ç¯å¢ƒå·²åˆ›å»ºï¼ˆunified-ms-envï¼‰
- [ ] âœ… PyTorch 2.3.1+cu118 å·²å®‰è£…
- [ ] âœ… PyTorch Lightning 2.0.4 å·²å®‰è£…
- [ ] âœ… torch_geometric 2.3.1 å·²å®‰è£…
- [ ] âœ… DGL 2.4.0+cu118 å·²å®‰è£…
- [ ] âœ… å…¶ä»–ä¾èµ–å·²å®‰è£…
- [ ] âœ… ms-pred Cython æ–‡ä»¶å·²ä¿®å¤
- [ ] âœ… ms-pred PyTorch Lightning API å·²æ›´æ–°ï¼ˆ13ä¸ªæ–‡ä»¶ï¼‰
- [ ] âœ… DiffMS å·²å®‰è£…ï¼ˆpip install -e .ï¼‰
- [ ] âœ… ms-pred å·²å®‰è£…ï¼ˆpython setup.py developï¼‰
- [ ] âœ… åŸºç¡€éªŒè¯æµ‹è¯•é€šè¿‡
- [ ] âœ… é¡¹ç›®å¯¼å…¥éªŒè¯é€šè¿‡
- [ ] âœ… GPU åŠŸèƒ½éªŒè¯é€šè¿‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†å®‰è£…æ–‡æ¡£ï¼š** `/root/ms/UNIFIED_ENVIRONMENT_SETUP_SUMMARY.md`
- **ç¯å¢ƒé…ç½®ï¼š** `/root/ms/unified_environment.yml`
- **Python ä¾èµ–ï¼š** `/root/ms/unified_requirements.txt`
- **DiffMS READMEï¼š** `/root/ms/DiffMS/README.md`
- **ms-pred READMEï¼š** `/root/ms/ms-pred/README.md`

---

## ğŸ’¡ æç¤º

1. **ç¯å¢ƒå¯¼å‡ºå»ºè®®ï¼š** åœ¨åŸæœºå™¨ä¸Šå®šæœŸå¯¼å‡ºç¯å¢ƒé…ç½®
   ```bash
   mamba env export > unified-ms-env-$(date +%Y%m%d).yml
   ```

2. **ä½¿ç”¨å®¹å™¨åŒ–ï¼š** è€ƒè™‘ä½¿ç”¨ Docker æˆ– Singularity å®¹å™¨æ¥ç®€åŒ–éƒ¨ç½²
   ```dockerfile
   FROM continuumio/miniconda3
   # ... æ·»åŠ å®‰è£…æ­¥éª¤
   ```

3. **ç‰ˆæœ¬æ§åˆ¶ï¼š** å°†ä»£ç ä¿®æ”¹ï¼ˆCython ä¿®å¤ã€API æ›´æ–°ï¼‰æäº¤åˆ° git
   ```bash
   git commit -am "Fix: PyTorch Lightning 2.0 compatibility"
   ```

4. **è‡ªåŠ¨åŒ–è„šæœ¬ï¼š** åˆ›å»ºå®‰è£…è„šæœ¬è‡ªåŠ¨åŒ–è¿™äº›æ­¥éª¤

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-10-16  
**æœ€åæ›´æ–°ï¼š** 2025-10-16  
**ç»´æŠ¤è€…ï¼š** [Your Name]

